/*--------------------------------*- C++ -*----------------------------------*\
| =========                 |                                                 |
| \\      /  F ield         | OpenFOAM: The Open Source CFD Toolbox           |
|  \\    /   O peration     | Version:  v2512                                 |
|   \\  /    A nd           | Website:  www.openfoam.com                      |
|    \\/     M anipulation  |                                                 |
\*---------------------------------------------------------------------------*/
FoamFile
{
    format      ascii;
    class       dictionary;
    location    "system";
    object      controlDict;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //

application         simpleFoam;
startFrom           latestTime;
startTime           0;
stopAt              endTime;
endTime             100;
deltaT              1;
writeControl        timeStep;
writeInterval       50;
purgeWrite          0;
writeFormat         ascii;
writePrecision      12;
writeCompression    off;
timeFormat          general;
timePrecision       12;
runTimeModifiable   yes;

libs
(
    "libexternalSpecieDiffusionResistance.so"
);


functions
{
    writeCellVolumes
    {
        type            writeCellVolumes;
        libs            (fieldFunctionObjects);
        writeControl    writeTime;
    }

    writeCellCentres
    {
        type            writeCellCentres;
        libs            (fieldFunctionObjects);
        writeControl    writeTime;
    }

    D_CO2
    {
        type            exprField;
        libs            (fieldFunctionObjects);
        field           D_CO2;
        fieldType       volTensorField;
        writeControl    writeTime;
        expression      "tensor(1.6e-9, 0, 0, 0, 0, 0, 0, 0, 0)";
        dimensions      [0 2 -1 0 0 0 0];
    }

    D_S
    {
        type            exprField;
        libs            (fieldFunctionObjects);
        field           D_S;
        fieldType       volTensorField;
        writeControl    writeTime;
        expression      "tensor(2.7e-9, 0, 0, 0, 0, 0, 0, 0, 0)";
        dimensions      [0 2 -1 0 0 0 0];
    }

    k_rxn
    {
        type            exprField;
        libs            (fieldFunctionObjects);
        field           k_rxn;
        writeControl    writeTime;
        expression      "pow(10, 11.365-(2211/298.15)) * pow(10, 0.1065*S+0.368)";
        dimensions      [0 0 -1 0 0 0 0];
    }

    H_cc
    {
        type            exprField;
        libs            (fieldFunctionObjects);
        field           H_cc;
        writeControl    writeTime;
        expression      "0.42";
        dimensions      [0 0 0 0 0 0 0];
    }

    CO2
    {
        type            aniScalarTransport;
        libs            (solverFunctionObjects);
        writeControl    writeTime;
        field           C_CO2;
        nut             D_CO2;
        alphaD          0;
        alphaDt         1;

        fvOptions
        {
            reaction
                {
                    type            scalarCodedSource;
                    name            CO2_react;
                    selectionMode   all;
                    fields          (C_CO2);
                    active          yes;

                    codeOptions
                    #{#};

                    codeConstrain
                    #{#};

                    codeCorrect #{#};

                    codeInclude
                    #{
                        #include "fvCFD.H"
                    #};

                    codeAddSup
                    #{
                        const scalarField& V = mesh_.V();
                        
                        const fvMesh& mesh = eqn.psi().mesh();
                        const volScalarField& k_rxn = mesh.lookupObject<volScalarField>("k_rxn");
                        const volScalarField& C_S  = mesh.lookupObject<volScalarField>("C_S");
                        const volScalarField& C_Sold = C_S.oldTime();

                        scalarField& Sp = eqn.diag();

                        forAll(Sp, cellI)
                        {
                            const scalar coeff = 0.5 * k_rxn[cellI] * C_Sold[cellI];
                            Sp[cellI] -= coeff * V[cellI];
                        }
                    #};
                }
        }
    }

    S
    {
        type            aniScalarTransport;
        libs            (solverFunctionObjects);
        writeControl    writeTime;
        field           C_S;
        nut             D_S;
        alphaD          0;
        alphaDt         1;

        fvOptions
        {
            reaction
                {
                    type            scalarCodedSource;
                    name            S_react;
                    selectionMode   all;
                    fields          (C_S);
                    active          yes;

                    codeOptions
                    #{#};

                    codeConstrain
                    #{#};

                    codeCorrect #{#};

                    codeInclude
                    #{
                        #include "fvCFD.H"
                    #};

                    codeAddSup
                    #{
                        const scalarField& V = mesh_.V();
                        
                        const fvMesh& mesh = eqn.psi().mesh();
                        const volScalarField& k_rxn = mesh.lookupObject<volScalarField>("k_rxn");
                        const volScalarField& C_CO2  = mesh.lookupObject<volScalarField>("C_CO2");
                        const volScalarField& C_CO2old = C_CO2.oldTime();                       

                        scalarField& Sp = eqn.diag();

                        forAll(Sp, cellI)
                        {
                            const scalar coeff = k_rxn[cellI] * C_CO2old[cellI];
                            Sp[cellI] -= coeff * V[cellI];
                        }
                    #};
                }
        }
    }
}

// ************************************************************************* //